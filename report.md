Согласно ТЗ проект состоит из двух репозиториев:

https://github.com/Osmos-GT/slurm-graduation-app
https://github.com/Osmos-GT/slurm-graduation-iac

Репозитории находятся в одной группе и используют одно хранилище переменных. Некоторые переменные, например, deploy token или адрес базы данных автоматически запрашиваются и добавляются в хранилище переменных через API. Это позволяет не добавлять переменные два раза, а после полного выполнения iac-пайплайна можно сразу запускать пайплайн в app-репозитории. При выполнении terraform destroy переменная с адресом БД также удаляется. Перечень необходимых переменных указан в readme app-репозитория.

При построении пайплайнов я не пользовался include-ами и шаблонами, т. к., на мой взгляд, удобнее, когда весь yaml одним файлом и не нужно ходить куда-то еще.

Все компоненты приложения запущены минимум в двух экземплярах (Redis — в трех). Кластер БД состоит из двух нод.

IaC-репозиторий

IaC-репозиторий позволяет создать (или уничтожить) и настроить инфраструктуру для запуска учебного приложения, установить с помощью helm все необходимые компоненты: ingress, certmanager, gitlab-runner, redis. Таким образом, из app-репозитория ставится только yelb-appserver и yelb-ui. Вручную создаётся только сам Gitlab, так как Yandex cloud не поддерживает создание Managed service for Gitlab через Terraform.

Terraform настроен хранить свой state в Gitlab.

Все шаги после построения плана выполняются вручную, что позволяет предварительно изучить созданный план и установить только необходимые чарты.

Gitlab использует два раннера.
Поскольку для создания кластера k8s, в котором будет работать основной раннер, тоже нужен раннер, то первоначальный деплой инфраструктуры производится с помощью раннера, запущенного в minikube у меня локально. В реальных условиях это может быть раннер, работающий в другом кластере. После деплоя инфраструктуры на этапе gitrunner-deploy  в кластер устанавливается раннер, который получит через API токен и автоматически зарегистрируется в Gitlab.

Раннер устанавливается из локального чарта в директории gitlab-runner iac-репозитория. От официального чарта он отличается тем, что я в нем исправил досадный баг, приводящий к проблеме с правами раннера в кластере (https://gitlab.com/gitlab-org/charts/gitlab-runner/-/issues/353) и скорректировал values.

Поскольку приложение ожидает в базе данных таблицу определённой структуры, предусмотрен этап DB-prepare с подготовкой БД. БД не имеет публичного адреса в целях безопасности.

App-репозиторий

Пайплайн app-репозитория, как и IaC-пайплайн, согласно ТЗ предусматривает вначале этапы lint (terraform validate в IaC). Линтер Ruby, например, Rubocop, я не стал включать в пайплайн, т. к. тестовое приложение эту проверку не проходит.

Пайплайн предусматривает базовую проверку образов yelb-appserver и yelb-ui с помощью curl. В реальных условиях желательно предусмотреть тестирование с помощью, например, Selenium, но это выходит за пределы курса.

После загрузки образов в registry выполняется очистка. Раннер удаляет с ноды все собранные образы appserver и ui, кроме последних. Это позволяет значительно ускорить следующую сборку с помощью кэша, и в то же время не захламлять ноду, где работает раннер.

Перед деплоем отдельным этапом через API будут получены логин и пароль для доступа  в хранилище образов только в том случае, если соответствующие переменные в хранилище переменных отсутствуют. Для обновления логина и пароля нужно лишь удалить из хранилища переменные DEPLOY_TOKEN_USER и DEPLOY_TOKEN_PASS, и новые будут добавлены заново.
